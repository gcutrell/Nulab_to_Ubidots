<scripts>
	<script name="ParseCmdLines" >
	  <loadvars file="NuLAB_Logging.csv" type="text" line="1" 
		   delimiter="," 
		   vars="Tab1,N+Nrblank,NO2rblank,PO4rblank,NH4rblank,N+Nobs,
		   NO2obs,PO4obs,NH4obs,Unit,Station" multi="False" />
	 	<loadvars file="NuLAB_Logging.csv" type="text" line="2" delimiter="," 
		   vars="Tab2,Email1,Email2,Email3,Email4,Email5,FileTransfer,
		   MonthlyRO,SFTP" multi="False" />
		<loadvars file="NuLAB_Logging.csv" type="text" line="3" delimiter="," 
						vars="Tab3,RunN+N,RunNO2,RunPO4,RunNH4,PumpRunTime,InFlush,STE,
						Smp2OBS,N+N_BkFlush,PO4_BkFlush,NH4_BkFlush,Interval,StartTime,
						EndDate,EndHour,StartLogging" multi="False" />
	
	<log message="Parsed Cmd Line 1 into --> [Tab1],[N+Nrblank],[NO2rblank],[PO4rblank],[NH4rblank],[N+Nobs],[NO2obs],[PO4obs],[NH4obs],[Unit],[Station]" />
	<log message="Parsed Cmd Line 2 into --> [Tab2],[Email1],[Email2],[Email3],[Email4],[Email5],[FileTransfer],[MonthlyRO],[SFTP]" />
	<log message="Parsed Cmd Line 3 into --> [Tab3],[RunN+N],[RunNO2],[RunPO4],[RunNH4],[PumpRunTime],[InFlush],[STE],[Smp2OBS],[N+N_BkFlush],[PO4_BkFlush],[NH4_BkFlush],[Interval],[StartTime],[EndDate],[EndHour],[StartLogging]" />

   </script>
		
     <script name="ResetCmdLines" >
	<delete file="NuLAB_Logging.csv" />
	<write file="NuLAB_Logging.csv" string="[Tab1],[N+Nrblank],[NO2rblank],[PO4rblank],[NH4rblank],[N+Nobs],[NO2obs],[PO4obs],[NH4obs],[Unit],[Station]{10}" />
	<write file="NuLAB_Logging.csv" string="[Tab2],[Email1],[Email2],[Email3],[Email4],[Email5],[FileTransfer],[MonthlyRO],[SFTP]{10}" />
	<write file="NuLAB_Logging.csv" string="[Tab3],[RunN+N],[RunNO2],[RunPO4],[RunNH4],[PumpRunTime],[InFlush],[STE],[Smp2OBS],[N+N_BkFlush],[PO4_BkFlush],[NH4_BkFlush],[Interval],[StartTime],[EndDate],[EndHour],0{10}" /><write file="NuLAB_Logging.csv" string="[Tab4],[DataFiltering]"/>
     </script>

  <script name="WriteOutput" >
	<delete file="NuLAB_Logging_Output.csv" />	 
	<write file="NuLAB_Logging_Output.csv" 
	string="Messages and Latest Results,[SysMessage],[SupplyVolts],[N+N_OBSabs],[N+Nconc],[NO2_OBSabs],[NO2conc],[PO4_OBSabs],[PO4conc],[NH4_OBSabs],[NH4conc] " />
  </script>

   <script name="CheckAction" >  
	<if condition="[StartLogging]==1" >
		<run script="ResetCmdLines" />
			<if condition="([RunN+N] == 1) OR ([RunNO2] == 1)" >
				<set vars="Chnl,Chem" value="1,Nitrate" />			
				<run script="ActiveChnlOn" />
				<setdevice name="Nitrate" />
				<run script="CommsCheck" />
			</if>
			<if condition="([RunPO4] == 1)" >
				<set vars="Chnl,Chem" value="2,Phosphate" />			
				<run script="ActiveChnlOn" />
				<setdevice name="Phosphate" />
				<run script="CommsCheck" />
			</if>
			<if condition="([RunNH4] == 1)" >
				<set var="Chnl,Chem" value="3,Ammonium" />			
				<run script="ActiveChnlOn" />
				<setdevice name="Ammonium" />
				<run script="CommsCheck" />
			
               		</if>
		<set var="SysMessage" value="Starting Logging Cycle" />
		<run script="WriteOutput" />
		<pause seconds="2" />
		<run script="LoggingCycle" />
	</if>

   </script>

  <script name="CommsCheck" >
	<!--send string="/[Chnl]{13}" />
	<pause ms="500" /-->
	<set var="NLreply" value="-999" />
	<set vars="SizeOfReply,i" value="0,0" />
	<while condition="([SizeOfReply] LT 40) AND ([i] LT 3)"	>
		<send string="/[Chnl]I0{13}"  behavior="tt" var="NLreply" trigger="{13}" terminator="." keeptrigger="false" keepterminator="false" ms="0" timeout="1000" />
		<log message= "Sent /[Chnl]I0 and received: [NLreply]" />
		<sizeof var="NLreply" result="SizeOfReply" type="length" />
		
		<if condition="[SizeOfReply] GT 40" >
			<set var="SysMessage" value="Comms Check on [Chem] Successful" />
			<loadvars string="[NLreply]" delimiter="," vars="TS,SN,WVL,Data1,Data2,Data3,RxTarget,DACdirect,StNum,TargetTemp" />
			<set var="DetConfig" value="[SN] [WVL] [Data1] [Data2] [Data3] [RxTarget] [DACdirect] [StNum] [TargetTemp]" />
			<if condition="[Data2] GT 1000" >		
				<set var="SysMessage" value="Notice - Data buffer will overflow soon - Clearing [Chem] Data now" />
				<run script="DataClear" />
				<run script="WriteOutput" />
				<pause seconds="20" />
			</if>
			<pause seconds="2" />
			<run script="WriteOutput" />
		<else>
			<set var="SysMessage" value="Comms Check on [Chem] Failed" />
			<run script="WriteOutput" />
			<pause seconds="2" />
			<set var="SysMessage" value="Please check power and serial cables on [Chem] channel" />
			<run script="WriteOutput" />
			<pause seconds="5" />
			<set var="SysMessage" value="Stopping program execution" />
			<run script="WriteOutput" />
			<kill/>
		</else>
		</if>
		<math var="i" expression="[i]+1" />
	</while>
	
	<run script="WriteOutput" />
	<pause seconds="1" />
  </script>

  <script name="RunMacros" >
        <run script="ReadSupplyVolts"/>
        <while condition="([VoltsFlag] == 1)">
               <pause ms="60000"/>
               <run script="ReadSupplyVolts"/>
        </while>
  	<if condition="([RunN+N] == 1) AND ([NitrateBubbleFlag] == 0)" >
		<set var="NLreply" value="-999" />
		<set var="AnalTime" value="[NO3mac1rt]" />
		<setdevice name="Nitrate" />
		<send string="/1N10{13}"  behavior="tt" var="ClearedData" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
		<pause ms="500" />
		<send string="/1[Macro]{13}"  behavior="tt" var="NLreply" trigger="{13}" terminator="***" keeptrigger="false" keepterminator="true" ms="0" timeout="10000" />
		<log message="NuLAB responded to /1[Macro] with [NLreply]" />
		<if condition=" '[NLreply]' == '***' ">
			<set var="SysMessage" value="N+N Macro Command Successful" />
			<set var="MacroRunning" value="1" />
			<else>
				<set var="SysMessage" value="N+N Macro Command Failed" />
			</else>
		</if>
		<run script="WriteOutput" />
		<pause ms="1000" />
	</if>

	<if condition="([RunPO4] == 1) AND ([PhosphateBubbleFlag] == 0)" >
		<set var="NLreply" value="-999" />
		<if condition="[PO4mac1rt] GT [AnalTime]" >
			<set var="AnalTime" value="[PO4mac1rt]" />
		</if>
		<setdevice name="Phosphate" />
		<send string="/2N10{13}"  behavior="tt" var="ClearedData" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
		<pause ms="500" />
		<send string="/2[Macro]{13}"  behavior="tt" var="NLreply" trigger="{13}" terminator="***" keeptrigger="false" keepterminator="true" ms="0" timeout="10000" />
		<log message="NuLAB responded to /2[Macro] with [NLreply]" />
		<if condition=" '[NLreply]' == '***' ">
			<set var="SysMessage" value="Phosphate Macro Command Successful" />
			<set var="MacroRunning" value="1" />
			<else>
				<set var="SysMessage" value="Phosphate Macro Command Failed" />
			</else>
		</if>
		<run script="WriteOutput" />
		<pause ms="1000" />
	</if>

	<if condition="([RunNH4] == 1) AND ([AmmoniumBubbleFlag] == 0)" >
		<set var="NLreply" value="-999" />
		<if condition="[NH4mac1rt] GT [AnalTime]" >
			<set var="AnalTime" value="[NH4mac1rt]" />
		</if>
		<setdevice name="Ammonium" />
		<send string="/3N10{13}"  behavior="tt" var="ClearedData" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
		<pause ms="500" />
		<send string="/3[Macro]{13}"  behavior="tt" var="NLreply" trigger="{13}" terminator="***" keeptrigger="false" keepterminator="true" ms="0" timeout="10000" />
		<log message="NuLAB responded to /3[Macro] with [NLreply]" />
		<if condition=" '[NLreply]' == '***' ">
			<set var="SysMessage" value="Ammonium Macro Command Successful" />
			<set var="MacroRunning" value="1" />
			<else>
				<set var="SysMessage" value="Ammonium Macro Command Failed" />
			</else>
		</if>
		<run script="WriteOutput" />
		<pause ms="1000" />
	</if>

  </script>
  
	<script name = "CheckMacroResults">
		<if condition="'[RunN+N]' == '1'">
			<setdevice name="Nitrate" />
			<send string="/1?{13}"  behavior="tt" var="MacroExitStatus" trigger="{13}" terminator="." keeptrigger="false" keepterminator="false" ms="0" timeout="2000" />
			
			<if condition="'[MacroExitStatus]' != '0'" >
				<set var="Error" value="Macro [Macro] failed on channel 1 with error code [MacroExitStatus]" />
				<run script="EmailAlarm" />
			</if>
		</if>
		
		<if condition="'[RunPO4]' == '1'">
			<setdevice name="Phosphate" />
			<send string="/2?{13}"  behavior="tt" var="MacroExitStatus" trigger="{13}" terminator="." keeptrigger="false" keepterminator="false" ms="0" timeout="2000" />

			<if condition="'[MacroExitStatus]' != '0'" >
				<set var="Error" value="Macro [Macro] failed on channel 2 with error code [MacroExitStatus]" />
				<run script="EmailAlarm" />
			</if>
		</if>

		<if condition="'[RunNH4]' == '1'">
			<setdevice name="Ammonium" />
			<send string="/3?{13}"  behavior="tt" var="MacroExitStatus" trigger="{13}" terminator="." keeptrigger="false" keepterminator="false" ms="0" timeout="2000" />

			<if condition="'[MacroExitStatus]' != '0'" >
				<set var="Error" value="Macro [Macro] failed on channel 3 with error code [MacroExitStatus]" />
				<run script="EmailAlarm" />
			</if>
		</if>
	</script>

  <script name="GetData" >
	<if condition="([RunN+N] == 1)" >
		<set var="2lines" value="-999" />
		<setdevice name="Nitrate" />
		<send string="/1N2{13}"  behavior="tt" var="2lines" trigger="{13}"
						terminator="." keeptrigger="true" keepterminator="false" ms="0" 
						timeout="10000" />
		<sizeof var="2lines" result="SizeOf2lines" type="length" />	
		<if condition="[SizeOf2lines] GT 80" >
			<set var="N+NDataFlag" value="1" />
			<set var="SysMessage" value="Data Collected" />
			<loadvars string="[2lines]" type="string" delimiter="," 
							vars="NLdatetime1,flag1,I0,an1,an2,an3,an4,an5,anTemp-B,an7-jnk,
							ALdatetime2,flag2,I1,an6,an7,an8,an9,an10,anTemp-R,jnk,jnk" 
							multi="True" />
			<math var="N+Nabs" expression="Log10([I0]/[I1])" />
			<math var="N+Nabs" expression="Round([N+Nabs],4)" />
			<write file="N+N_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],N+N,[flag1],[I0],[an2],[an4],[an5],[anTemp-B],[N+Nrblank]{13}{10}" />
			<write file="N+N_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],N+N,[flag2],[I1],[an7],[an9],[an10],[anTemp-R],[N+Nrblank]" />
			<if condition=" '[Macro]' = 'M2' " >
				<write file="N+N_Data-L.txt" string=",OBSabs=,[N+Nabs],[DataSpacer],[DataSpacer],OBSconc=,[N+Nobs],[DataSpacer],[DataSpacer]" />
				
				<!--CHECK DATA-->
				<run file="check_data.sh" args="N+N_Data-L.txt OBS_abs"/>
				<loadvars file="check_data_results.txt" type="text" 
						delimiter="{13}" vars="Error" />
				<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
				<if condition="'[CheckDataResults]' != '0'">
					<run script="EmailAlarm" />
				</if>
			</if>
			<if condition=" '[Macro]' = 'M1'" >
				<write file="N+N_Data-L.txt" string=",[DataSpacer],[DataSpacer],
								SmpAbs=,[N+Nabs],[DataSpacer],[DataSpacer]" />
                        </if>
			<else>
				<set var="SysMessage" value="No Data" />
				<set var="N+NDataFlag" value="-999" />
			</else>
		</if>
	</if>

	<if condition="[RunPO4] == 1" >
		<set var="2lines" value="-999" />
		<setdevice name="Phosphate" />
		<send string="/2N2{13}"  behavior="tt" var="2lines" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
		<sizeof var="2lines" result="SizeOf2lines" type="length" />	
		<if condition="[SizeOf2lines] GT 80" >
			<set var="PO4DataFlag" value="1" />
			<set var="SysMessage" value="Data Collected" />
			<loadvars string="[2lines]" type="string" delimiter="," vars="NLdatetime1,flag1,I0,an1,an2,an3,an4,an5,anTemp-B,an7-jnk,ALdatetime2,flag2,I1,an6,an7,an8,an9,an10,anTemp-R,jnk,jnk" multi="True" />
			<math var="PO4abs" expression="Log10([I0]/[I1])" />
			<math var="PO4abs" expression="Round([PO4abs],4)" />
			<write file="Phosphate_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],Phosphate,[flag1],[I0],[an2],[an4],[an5],[anTemp-B],[PO4rblank]{13}{10}" />
			<write file="Phosphate_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],Phosphate,[flag2],[I1],[an7],[an9],[an10],[anTemp-R],[PO4rblank]" />
			<if condition=" '[Macro]' = 'M2' " >
				<write file="Phosphate_Data-L.txt" string=",OBSabs=,[PO4abs],[DataSpacer],[DataSpacer],OBSconc=,[PO4obs],[DataSpacer],[DataSpacer]" />
				<!--CHECK DATA-->
				<run file="check_data.sh" args="Phosphate_Data-L.txt OBS_abs"/>
				<loadvars file="check_data_results.txt" type="text" 
						delimiter="{13}" vars="Error" />
				<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
				<if condition="'[CheckDataResults]' != '0'">
					<run script="EmailAlarm" />
				</if>
			</if>
			<if condition=" '[Macro]' = 'M1' " >
				<write file="Phosphate_Data-L.txt" string=",[DataSpacer],[DataSpacer],SmpAbs=,[PO4abs],[DataSpacer],[DataSpacer]" />
			</if>
			<else>
				<set var="SysMessage" value="No Data" />
				<set var="PO4DataFlag" value="-999" />
			</else>
		</if>
	</if>

	<if condition="[RunNH4] == 1" >
		<set var="2lines" value="-999" />
		<setdevice name="Ammonium" />
		<send string="/3N2{13}"  behavior="tt" var="2lines" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
		<sizeof var="2lines" result="SizeOf2lines" type="length" />	
		<if condition="[SizeOf2lines] GT 80" >
			<set var="NH4DataFlag" value="1" />
			<set var="SysMessage" value="Data Collected" />
			<loadvars string="[2lines]" type="string" delimiter="," vars="NLdatetime1,flag1,I0,an1,an2,an3,an4,an5,anTemp-B,an7-jnk,ALdatetime2,flag2,I1,an6,an7,an8,an9,an10,anTemp-R,jnk,jnk" multi="True" />
			<math var="NH4abs" expression="Log10([I0]/[I1])" />
			<math var="NH4abs" expression="Round([NH4abs],4)" />
			<write file="Ammonium_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],Ammonium,[flag1],[I0],[an2],[an4],[an5],[anTemp-B],[NH4rblank]{13}{10}" />
			<write file="Ammonium_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],Ammonium,[flag2],[I1],[an7],[an9],[an10],[anTemp-R],[NH4rblank]" />
			<if condition=" '[Macro]' = 'M2' " >
				<write file="Ammonium_Data-L.txt" string=",OBSabs=,[NH4abs],[DataSpacer],[DataSpacer],OBSconc=,[NH4obs],[DataSpacer],[DataSpacer]" />
						
				<!--CHECK DATA-->
				<run file="check_data.sh" args="Ammonium_Data-L.txt OBS_abs"/>
				<loadvars file="check_data_results.txt" type="text" 
						delimiter="{13}" vars="Error" />
				<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
				<if condition="'[CheckDataResults]' != '0'">
					<run script="EmailAlarm" />
				</if>
			</if>
			<if condition=" '[Macro]' = 'M1' " >
				<write file="Ammonium_Data-L.txt" string=",[DataSpacer],[DataSpacer],SmpAbs=,[NH4abs],[DataSpacer],[DataSpacer]" />
			</if>
			<else>
				<set var="SysMessage" value="No Data" />
				<set var="NH4DataFlag" value="-999" />
			</else>
		</if>		
	</if>
	<run script="WriteOutput" />
  </script>

  <script name="RunNO2Macros"  >
        <run script="ReadSupplyVolts"/>
        <while condition="([VoltsFlag] == 1)">
               <pause ms="60000"/>
               <run script="ReadSupplyVolts"/>
        </while>
	<set var="NLreply" value="-999" />
	<setdevice name="Nitrate" />
	<send string="/1N10{13}"  behavior="tt" var="ClearedData" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
	<pause ms="500" />
	<send string="/1[Macro]{13}"  behavior="tt" var="NLreply" trigger="{13}" terminator="***" keeptrigger="false" keepterminator="true" ms="0" timeout="10000" />
	<log message="NuLAB responded to /1[Macro] with [NLreply]" />
	<if condition=" '[NLreply]' == '***' ">
		<set var="SysMessage" value="Nitrite Macro Command Successful" />
		<set var="MacroRunning" value="1" />
		<else>
			<set var="SysMessage" value="Nitrite Macro Command Failed" />
		</else>
	</if>
	<run script="WriteOutput" />
	<pause ms="2000" />
  </script>

  <script name="GetNO2Data" >
	<set var="2lines" value="-999" />
	<setdevice name="Nitrate" />
	<send string="/1N2{13}"  behavior="tt" var="2lines" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
	<sizeof var="2lines" result="SizeOf2lines" type="length" />	
	<if condition="[SizeOf2lines] GT 80" >
		<set var="NO2DataFlag" value="1" />
		<set var="SysMessage" value="Data Collected" />
		<loadvars string="[2lines]" type="string" delimiter="," vars="NLdatetime1,flag1,I0,an1,an2,an3,an4,an5,anTemp-B,an7-jnk,ALdatetime2,flag2,I1,an6,an7,an8,an9,an10,anTemp-R,jnk,jnk" multi="True" />
		<math var="NO2abs" expression="Log10([I0]/[I1])" />
		<math var="NO2abs" expression="Round([NO2abs],4)" />
		<write file="Nitrite_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],NO2,[flag1],[I0],[an2],[an4],[an5],[anTemp-B],[NO2rblank]{13}{10}" />
		<write file="Nitrite_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],[Macro],NO2,[flag2],[I1],[an7],[an9],[an10],[anTemp-R],[NO2rblank]" />
		<if condition=" '[Macro]' = 'M8' " >
			<write file="Nitrite_Data-L.txt" string=",OBSabs=,[NO2abs],[DataSpacer],[DataSpacer],OBSconc=,[NO2obs],[DataSpacer],[DataSpacer]{10}{13}" />

			<!--CHECK DATA-->
			<run file="check_data.sh" args="Ammonium_Data-L.txt OBS_abs"/>
			<loadvars file="check_data_results.txt" type="text" 
					delimiter="{13}" vars="Error" />
			<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
			<if condition="'[CheckDataResults]' != '0'">
				<run script="EmailAlarm" />
			</if>
		</if>
		<if condition=" '[Macro]' = 'M7' " >
			<write file="Nitrite_Data-L.txt" string=",[DataSpacer],[DataSpacer],SmpAbs=,[NO2abs],[DataSpacer],[DataSpacer]" />
		</if>
		<else>
			<set var="SysMessage" value="No Data" />
			<set var="NO2DataFlag" value="-999" />
		</else>
	</if>
	<run script="WriteOutput" />
  </script>

  <script name="DataClear" >
	<send string="/[Chnl]X5525{13}"  behavior="tt" var="NLreply" trigger="{13}" terminator="." keeptrigger="false" keepterminator="true" ms="0" timeout="2000" />
	<if condition=" '[NLreply]' == '.' ">
		<set var="SysMessage" value="[Chnl2Clear] Data Cleared" />
		<else>
			<set var="SysMessage" value="[Chnl2Clear] Data NOT Cleared!" />
		</else>
	</if>
  </script>

  <script name="RunOBSs" >
		<!-- OBS macros -->
		<set var="MacroRunning" value="0" />
		<set var="Macro" value="M2" />
		<date var="Date" format="MM/dd/yyyy" />
		<date var="Time" format="HH:mm:ss" />
		<run script="RunMacros" /> <!-- Run selected N+N, PO4, NH4 -->
		<if condition="[MacroRunning] == 1" >
			<pause seconds="[AnalTime]" />
		</if>
		
		<run script="CheckMacroResults" />

		<!-- Get OBS data -->
		<set var="DataSpacer" value="   " />
		<run script="GetData" />
		<set var="N+N_OBSabs" value="[N+Nabs]" />
		<set var="PO4_OBSabs" value="[PO4abs]" />
		<set var="NH4_OBSabs" value="[NH4abs]" />
		<set var="MacroRunning" value="0" />
	
		<!-- Special Case for NO2 -->	
		<if condition="[RunNO2] == 1 " >
			<set var="Macro" value="M8" />
			<date var="Date" format="MM/dd/yyyy" />
			<date var="Time" format="HH:mm:ss" />
			<run script="RunNO2Macros" />
			<if condition="[MacroRunning] == 1" >
				<pause seconds="[NO3mac8rt]" />
			</if>

			<run script="CheckMacroResults" />

			<run script="GetNO2Data" />
			<set var="NO2_OBSabs" value="[NO2abs]" />
		</if>

  </script>

  <script name="RunSmps" >
		<!-- Smp macros -->
		<set var="MacroRunning" value="0" />
		<set var="Macro" value="M1" />
		<!--date var="Date" format="MM/dd/yyyy" />
		<date var="Time" format="HH:mm:ss" /--> <!-- Data and Time set when pump turns off -->
		<date var="Date" format="MM/dd/yyyy" />
		<date var="Time" format="HH:mm:ss" />
		<run script="RunMacros" /> <!-- Run selected N+N, PO4, NH4 -->
		<if condition="[MacroRunning] == 1" >
			<pause seconds="[AnalTime]" />
		</if>
		
		<run script="CheckMacroResults" />

		<!-- Get Smp data -->
		<set var="DataSpacer" value="   " />
		<run script="GetData" />
		<set var="N+N_Smp_abs" value="[N+Nabs]" />
		<set var="PO4_Smp_abs" value="[PO4abs]" />
		<set var="NH4_Smp_abs" value="[NH4abs]" />
		<set var="MacroRunning" value="0" />
		<run script="CalcConc" />
	
		<!-- Special Case for NO2 -->	
		<if condition="[RunNO2] == 1" >
			<set var="Macro" value="M7" />
			<date var="Date" format="MM/dd/yyyy" />
			<date var="Time" format="HH:mm:ss" />
			<run script="RunNO2Macros" />
			<if condition="[MacroRunning] == 1" >
				<pause seconds="[NO3mac7rt]" />
			</if>

			<run script="CheckMacroResults" />

			<run script="GetNO2Data" />
			<set var="NO2_Smp_abs" value="[NO2abs]" />
			<run script="CalcNO2Conc" />
		</if>

  </script>

  <script name="CalcConc" >
		<if condition="([RunN+N] == 1) AND ([N+NDataFlag] != -999) " >
			<math var="N+Nconc" expression="([N+N_Smp_abs]-[N+Nrblank])
							/( ([N+N_OBSabs] - [N+Nrblank])/[N+Nobs] )" />
			<math var="N+Nconc" expression="Round([N+Nconc],3)" />
			<write file="N+N_Data-L.txt" string=",SmpConc=,[N+Nconc]{10}{13}" />
		</if>
	<if condition="([RunPO4] == 1) AND ([PO4DataFlag] != -999)" >
		<math var="PO4conc" expression="([PO4_Smp_abs]-[PO4rblank])/( ([PO4_OBSabs] - [PO4rblank])/[PO4obs] )" />
		<math var="PO4conc" expression="Round([PO4conc],3)" />
		<write file="Phosphate_Data-L.txt" string=",SmpConc=,[PO4conc]" />

		<!--CHECK DATA-->
		<run file="check_data.sh" args="Phosphate_Data-L.txt Smp_conc\(uM\)"/>
		<loadvars file="check_data_results.txt" type="text" 
				delimiter="{13}" vars="Error" />
		<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
		<if condition="'[CheckDataResults]' != '0'">
			<run script="EmailAlarm" />
		</if>
	</if>
	<if condition="([RunNH4] == 1) AND ([NH4DataFlag] != -999)" >
		<math var="NH4conc" expression="([NH4_Smp_abs]-[NH4rblank])
			/( ([NH4_OBSabs] - [NH4rblank])/[NH4obs] )" />
		<math var="NH4conc" expression="Round([NH4conc],3)" />
		<write file="Ammonium_Data-L.txt" string=",SmpConc=,[NH4conc]" />

		
		<!--CHECK DATA-->
		<run file="check_data.sh" args="Ammonium_Data-L.txt Smp_conc\(uM\)"/>
		<loadvars file="check_data_results.txt" type="text" 
				delimiter="{13}" vars="Error" />
		<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
		<if condition="'[CheckDataResults]' != '0'">
			<run script="EmailAlarm" />
		</if>
	</if>
  </script>

  <script name="CalcNO2Conc" >
	<if condition="([RunNO2] == 1) AND ([NO2DataFlag] != -999)" >
		<math var="NO2conc" expression="([NO2_Smp_abs]-[NO2rblank])/( ([NO2_OBSabs] - [NO2rblank])/[NO2obs] )" />
		<math var="NO2conc" expression="Round([NO2conc],3)" />
		<write file="Nitrite_Data-L.txt" string=",SmpConc=,[NO2conc]{10}{13}" />
		<if condition="([RunN+N] == 1)" >	
			<math var="NO3conc" expression="[N+Nconc] - [NO2conc]" />
			<write file="Nitrate_Data-L.txt" string="[Date] [Time],[Station],[SupplyVolts],Nitrate,Conc=,[NO3conc]" />
			
			<!--CHECK DATA-->
			<run file="check_data.sh" args="Nitrate_Data-L.txt Smp_conc\(uM\)"/>
			<loadvars file="check_data_results.txt" type="text" 
					delimiter="{13}" vars="Error" />
			<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
			<if condition="'[CheckDataResults]' != '0'">
				<run script="EmailAlarm" />
			</if>
		 </if>
	</if>
  </script>

  <script name="MinTicker" >
	<while condition="[MinCount] LT [Delay]" >	
		<date var="Min0" format="mm" />
		<pause ms="1000" />
		<date var="Min1" format="mm" />
		<if condition="[Min0] == [Min1]" >
			<math var="MinCount" expression="[MinCount]+1" />
		</if>
	</while>
	
 </script>
 
 <script name="ActiveChnlsOn" >
 <!-- Power up active channels -->
	<if condition="([RunN+N] == 1) OR ([RunNO2] == 1)" >
		<set var="Chnl" value="1" />
		<run script="ActiveChnlOn" />
	</if>
	<if condition="([RunPO4] == 1)" >
		<set var="Chnl" value="2" />
		<run script="ActiveChnlOn" />
	</if>
	<if condition="([RunNH4] == 1)" >
		<set var="Chnl" value="3" />
		<run script="ActiveChnlOn" />
	</if>
 </script>
 
 <script name="ActiveChnlsOff" >
 <!-- Power down active channels -->
	<if condition="([RunN+N] == 1) OR ([RunNO2] == 1)" >
		<set var="Chnl" value="1" />
		<run script="ActiveChnlOff" />
	</if>
	<if condition="([RunPO4] == 1)" >
		<set var="Chnl" value="2" />
		<run script="ActiveChnlOff" />
	</if>
	<if condition="([RunNH4] == 1)" >
		<set var="Chnl" value="3" />
		<run script="ActiveChnlOff" />
	</if>
 </script>

 <script name="FileExistance">
         <exists path="N+N_Data-L.txt" result="var1"/>
         <if condition="('[var1]' == 'False') AND ([RunN+N] == 1) ">
             <write file="N+N_Data-L.txt" string="#MM/DD/YY HH:mm:SS,Station,Voltage,Macro,Chemical,Flag,Light,Ref_Light,Ch1_LED,Ch2_LED,Temp,Reg_Blk,---,OBS_abs,---,Smp_abs,---,OBS_conc([Unit]),---,Smp_conc([Unit]){10}{13}" />

         </if>
         <exists path="Phosphate_Data-L.txt" result="var2"/>
         <if condition="('[var2]' == 'False') AND ([RunPO4] == 1)">
             <write file="Phosphate_Data-L.txt" string="#MM/DD/YY HH:mm:SS,Station,Voltage,Macro,Chemical,Flag,Light,Ref_Light,Ch1_LED,Ch2_LED,Temp,Reg_Blk,---,OBS_abs,---,Smp_abs,---,OBS_conc([Unit]),---,Smp_conc([Unit]){10}{13}" />
         </if>
         <exists path="Ammonium_Data-L.txt" result="var3"/>
         <if condition="('[var3]' == 'False') AND ([RunNH4] == 1)">
             <write file="Ammonium_Data-L.txt" string="#MM/DD/YY HH:mm:SS,Station,Voltage,Macro,Chemical,Flag,Light,Ref_Light,Ch1_LED,Ch2_LED,Temp,Reg_Blk,---,OBS_abs,---,Smp_abs,---,OBS_conc([Unit]),---,Smp_conc([Unit]){10}{13}" />
         </if>
         <exists path="Nitrite_Data-L.txt" result="var4"/>
         <if condition="('[var4]' == 'False') AND ([RunNO2] == 1)">
             <write file="Nitrite_Data-L.txt" string="#MM/DD/YY HH:mm:SS,Station,Voltage,Macro,Chemical,Flag,Light,Ref_Light,Ch1_LED,Ch2_LED,Temp,Reg_Blk,---,OBS_abs,---,Smp_abs,---,OBS_conc([Unit]),---,Smp_conc([Unit]){10}{13}" />
         </if>
         <exists path="Nitrate_Data-L.txt" result="var5"/>
         <if condition="('[var5]' == 'False') AND ([RunNO2] == 1)">
             <write file="Nitrate_Data-L.txt" string="#MM/DD/YY HH:mm:SS,Station,Voltage,Chemical,---,Smp_conc([Unit]){10}{13}" />
         </if>

 </script>
	
 <script name="LoggingCycle" >
	
	<!-- delayed start -->
	<set var="SysMessage" value="Delaying Start" />
	<run script="WriteOutput" />
	<pause seconds="2" />
	<date var="CurrentHour" format="HH" />
	<date var="CurrentDate" format="MM/dd/yyyy" />
	<loadvars string="[StartTime]" type="string" delimiter=":" vars="StartHour,StartMinute"/>
	<date var="CurrentMinute" format="mm"/>
	<while condition="([CurrentHour] LT [StartHour]) AND ([CurrentMinute] LT [StartMinute])" >
		<date var="CurrentHour" format="HH" />
		<date var="CurrentMinute" format="mm"/>
		<pause ms="1000" />
	</while>
	<set var="SysMessage" value="Delayed Start Passed - Starting Logging" />
	<set var="SmpTotalCount" value="0"/>
	<run script="WriteOutput" />
	<pause seconds="4" />
	<set var="LoggingMode" value="1" />
	<log  message="End Date = [EndDate] --- Current Date = [CurrentDate] --- End Hour =  [EndHour]  --- Current Time = [CurrentHour]:[CurrentMinute]" />
	
        <run script="FileExistance"/>


	<!-- main logging loop -->
	<while condition="[LoggingMode]  == 1" >
		<!-- Start Logging Cycle -->
		<elapsedtime var="ElapsedMins" format="minutes" reset="true" />	
                
                <!--Start new data collection if month changes-->
                <run script="DateCompare" />
                <run script="WriteLastDate"/>

		<date var="CurrentHour" format="HH" />
		<date var="CurrentDate" format="MM/dd/yyyy" />
		<if condition=" '[EndDate]' == '[CurrentDate]'" >   <!--  Check for End Data then End Hour -->
			<log message="End Date = true" />
			<if condition=" [CurrentHour] GTE [EndHour] " >
				<set var="SysMessage" value="Logging End Time Reached" />
				<run script="WriteOutput" />
				<pause seconds="4" />
				<set var="LoggingMode" value="0" />
				<kill /> <!-- stop program -->
			</if>
		</if>
				
		<!-- Power up active channels -->
		<run script="ActiveChnlsOn" />
		
		<!--CommsCheck and data clear -->
                   <if condition="([RunN+N] == 1) OR ([RunNO2] == 1)" >
			<set vars="Chnl,Chem" value="1,Nitrate" />
                	<setdevice name="Nitrate" />
			<run script="CommsCheck" />
		   </if>
		   <if condition="([RunPO4] == 1)" >
			<set vars="Chnl,Chem" value="2,Phosphate" />
                	<setdevice name="Phosphate" />
			<run script="CommsCheck" />
		   </if>
		   <if condition="([RunNH4] == 1)" >
			<set var="Chnl,Chem" value="3,Ammonium" />
                	<setdevice name="Ammonium" />
			<run script="CommsCheck" />
                  </if>
		
	        <if condition="[LoggingMode] == 1" >
						<!-- OBSs -->
		    <log message="***RUNNING OBSs***" />
		    
		    <!--Start new data collection if month changes-->
                    <run script="DateCompare" />
                    <run script="WriteLastDate"/>

		    <set var="NitrateBubbleFlag" value="0" />
		    <set var="PhosphateBubbleFlag" value="0" />
		    <set var="AmmoniumBubbleFlag" value="0" />

		    <run script="RunOBSs" />
		    <run file="PlotNuLAB.sh" />
		    <run file="/home/pi/ComScriptPi/profiles/SendFiles/SendFiles.sh" />
                    <run script="ActiveChnlsOff" />
                    <pause seconds="300" /> <!-- pause to let detectors temperature equilibrate -->
		</if>

		<!-- Inlet Flushes and Samples loop -->		
		<set var="SmpCount" value="0" />
		<while condition="([SmpCount] LT [Smp2OBS]) AND ([LoggingMode] == 1)" >
		
			<!-- Run Pump -->
			<set var="SysMessage" value="Flushing Sample Chamber for [PumpRunTime] seconds" />
			<run script="WriteOutput" />
			<run script="PumpOn" />
			<pause seconds="[PumpRunTime]" />
			<run script="PumpOff" />
			<date var="Date" format="MM/dd/yyyy" />
			<date var="Time" format="HH:mm:ss" /> <!-- Pump off time used as Timestamp on sample data -->
			
			<!-- Pause for Temperature Equilibration-->
			<set var="SysMessage" value="Pause for [STE] minute(s) for temperature equilibration."/>
			<run script="WriteOutput"/>
			<set var="count" value="0"/>
			<while condition="[count] LT [STE]">
				<pause seconds="60"/>
				<math var="count" expression="[count]+1"/>
			</while>

			<!-- Power up active channels -->
                        <run script="ActiveChnlsOn" />

			<!-- Run Inlet Flushes -->			
			<set var="InFlushCount" value="0" />
			<if condition="[BackFlushFlag]==1"> <!--Run an extra Inlet Flush if BackFlush just excuted -->
                            <math var="InFlushCount" expression="[InFlushCount]-1" />
                            <set var="BackFlushFlag" value="0" />
                            </if>
			<while condition="[InFlushCount] LT [InFlush]" >
				<log message=" [InFlushCount] LT [InFlush] " />
				<set var="Macro" value="M3" />
				<log message="***RUNNING INLET FLUSHES***" />
				<run script="RunMacros" />
				<if condition=" ([RunNO2] == 1) AND ([RunN+N] == 0) ">  <!-- Flush NO2 if not running NO3 -->
					<run script="RunNO2Macros" />
				</if>
				<math var="InFlushCount" expression="[InFlushCount] + 1" />
				<pause seconds="120" />  <!-- two minute delay for inlet flush macro -->
			</while>

			<!-- Check inlet flush for bubbles -->
			<run script="InletCheck" />

			<!-- Run Samples -->
			<log message="***RUNNING SMPs***" />
                        <!-- Power up active channels -->
                        
                        <!--Start new data collection if month changes-->
                        <run script="DateCompare" />

                       	<run script="RunSmps" />

			<run file="PlotNuLAB.sh" /> <!-- plot data -->
			<math var="SmpCount" expression="[SmpCount] + 1" />
			<math var="SmpTotalCount" expression="[SmpTotalCount] + 1" />
					 
			<!-- Check for BkFlush Time and run on true -->
			<if condition="([N+N_BkFlush]==1)OR([PO4_BkFlush]==1)OR([NH4_BkFlush]==1)">
			    <date var="CurrentHour" format="HH" />
			    <math var="BFvar" expression="IEEERemainder([SmpTotalCount],Round((720/[Interval]),0))"/>
			    <if condition="[BFvar] == 0" >
                                <log message="***RUNNING INLET BACK-FLUSHES ON SELECTED CHANNEL***" />
                                <set vars="RunN+N,RunPO4,RunNH4" value="[N+N_BkFlush],[PO4_BkFlush],[NH4_BkFlush]"/>
			        <set var="Macro" value="M6" />
			        <run script="RunMacros" />
			        <run script="ParseCmdLines"/>
			        <pause seconds="150" /> <!-- pause for back-flush macro to execute -->

			        <date var="CurrentDate" format="MM/dd/yyyy" />
			        <date var="CurrentTime" format="HH:mm:ss" />
		                <if condition="[N+N_BkFlush]==1">
			            <write file="N+N_Data-L.txt" string="[CurrentDate] [CurrentTime],***Inlet Back-flush executed***{10}{13}" />
			            <write file="Nitrate_Data-L.txt" string="[CurrentDate] [CurrentTime],***Inlet Back-flush executed***{10}{13}" />
			            <write file="Nitrite_Data-L.txt" string="[CurrentDate] [CurrentTime],***Inlet Back-flush executed***{10}{13}" />
			        </if>
                                <if condition="[PO4_BkFlush]==1">
                                    <write file="Phosphate_Data-L.txt" string="[CurrentDate] [CurrentTime],***Inlet Back-flush executed***{10}{13}" />
                                </if>
                                <if condition="[NH4_BkFlush]==1">
                                    <write file="Ammonium_Data-L.txt" string="[CurrentDate] [CurrentTime],***Inlet Back-flush executed***{10}{13}" />
                                </if>
                                <set var="BackFlushFlag" value="1" />
                           </if>
                        </if>

		       <!-- Power down active channels -->
                       <run script="ActiveChnlsOff" />
			
			<!-- Check for Daily Email -->
				<if condition="[CurrentHour] == 17">
				<run file="/home/pi/ComScriptPi/profiles/SendEmails/SendEmails.sh" background="True"/>
				<set var="EmailFlag" value="1"/>
			</if>
			
			<if condition="([CurrentHour] GT 17) AND ([EmailFlag] == 0)">
			         <run file="/home/pi/ComScriptPi/profiles/SendEmails/SendEmails.sh" background="True"/>
                                 <set var="EmailFlag" value="1"/>
			</if>


			<!-- Check for File Transfer --> 
			<if condition="[FileTransfer] == 1" >
				<run file="/home/pi/ComScriptPi/profiles/SendFiles/SendFiles.sh" background="True"/>
			</if>

			<!-- Record last date -->
			<!--run script="WriteLastDate" /-->

			<!-- Slow delay loop for Interval -->
			<math var="IntervalLess1" expression="[Interval] -1" />
			<while condition="[ElapsedMins] LT [IntervalLess1]" >
				<pause ms="10000" />
				<elapsedtime var="ElapsedMins" format="minutes" reset="false" />
			</while>
			<!-- Fast delay loop for Interval when less than 1 minute to go-->
			<while condition="[ElapsedMins] LT [Interval]" >
				<pause ms="100" />
				<elapsedtime var="ElapsedMins" format="minutes" reset="false" />
			</while>
			<elapsedtime var="ElapsedMins" format="minutes" reset="true" /> <!-- reset ElapsedMins to 0 -->

			<if condition=" '[EndDate]' == '[CurrentDate]'" >   <!--  Check for End Data then End Hour...inside sample loop -->
				<log message="End Date = true" />
				<if condition=" [CurrentHour] GTE [EndHour] " >
					<set var="SysMessage" value="Logging End Time Reached" />
					<run script="WriteOutput" />
					<pause seconds="4" />
					<set var="LoggingMode" value="0" />
					<kill /> <!-- stop program -->
				</if>
			</if>
		
		<elapsedtime var="ElapsedMins" format="minutes" reset="true" /> <!-- reset elapsed time for repeating samples -->

		</while> <!-- end of samples loop -->

		<!-- load current date and hour -->
		<date var="CurrentHour" format="HH" />
		<date var="CurrentDate" format="MM/dd/yyyy" />
		
	</while> <!-- Main Logging Loop end --> 

	<kill />

	</script>

	<script name="CheckData">
		<if condition="'[Chemical]' == 'PO4'">
			<run file="check_data.sh" args="Phosphate_Data-L.txt Smp_conc(uM)"/>
			<loadvars file="check_data_results.txt" type="text" 
					delimiter="{13}" vars="Error" />
			<loadvars string="[Error]" delimiter = " " vars = "CheckDataResults" />
			<if condition="'[CheckDataResults]' != '0'">
				<run script="EmailAlarm" />
			</if>
		</if>
	</script>		

</scripts>


