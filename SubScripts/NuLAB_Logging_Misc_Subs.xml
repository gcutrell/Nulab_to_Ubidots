<scripts>

	<script name="CreateEmailAccount" >
		<emailaccount
		address="NuLAB@gescience.com"
		password="!Nutrients!"
		server="mail.gescience.com"
		default="true"
		ssl = "false" />
	</script>

	<script name="BuildEmailList" >
		<sizeof var="Email1" result="SizeOfEmail1" type="length" />
   		<if condition="[SizeOfEmail1] GT 7" >
			<set var="EmailList" value="[Email1]" />
		</if>
	
		<sizeof var="Email2" result="SizeOfEmail2" type="length" />
   		<if condition="[SizeOfEmail2] GT 7" >
			<set var="EmailList" value="[EmailList],[Email2]" />
		</if>

		<sizeof var="Email3" result="SizeOfEmail3" type="length" />
   		<if condition="[SizeOfEmail3] GT 7" >
			<set var="EmailList" value="[EmailList],[Email3]" />
		</if>

		<sizeof var="Email4" result="SizeOfEmail4" type="length" />
   		<if condition="[SizeOfEmail4] GT 7" >
			<set var="EmailList" value="[EmailList],[Email4]" />
		</if>

		<sizeof var="Email5" result="SizeOfEmail5" type="length" />
   		<if condition="[SizeOfEmail5] GT 7" >
			<set var="EmailList" value="[EmailList],[Email5]" />
		</if>
	</script>

	<script name="InletAlarm" >
		<typetest var="InletAlarmNum" type="int" result="isInletAlarmNum" />
		<if condition="'[isInletAlarmNum]' == 'False'">
			<set var="InletAlarmNum" value="1"/>
			<else>
				<math var="InletAlarmNum" expression="[InletAlarmNum]+1"/>
			</else>
		</if>
		<if condition="[InletAlarmNum] LT 4">
			<run script="BuildEmailList" />
			<log message="Email List = [EmailList]" />
			<sizeof var="EmailList" result="SizeOfEmailList" type="length" />
			<if condition="[SizeOfEmailList] GT 7" >
				<email to="[EmailList]" 
				subject="[Station] - [PCdate]" 
				message="The NuLAB system experienced the following error: Empty Inlet" 
				wait="true" onfail="true"/>
			</if>
		</if>
	</script>
	
	<script name="InletCheck">
		<set var="NitrateBubbleFlag" value="0" />
		<set var="PhosphateBubbleFlag" value="0" />
		<set var="AmmoniumBubbleFlag" value="0" />
		<set var="Macro" value="M5" />
		<run script="RunMacros" />
		<pause ms="300000" />
		<if condition="[RunN+N] == 1">
			<setdevice name="Nitrate" />
			<send string="/1N1{13}"  behavior="tt" var="InletCheckResult" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
			<loadvars string="[InletCheckResult]" type="string" delimiter="," 
							vars="junk1,junk2,I0,junk3,junk4,junk5,junk6,junk7,junk8,junk9"
							multi="True" />
			<if condition="([I0] GT '45000') OR ([I0] LT '35000')">
				<set var="NitrateBubbleFlag" value="1" />
				<run script="InletAlarm"/>
			</if>
		</if>

		<if condition="[RunPO4] == 1">
			<setdevice name="Phosphate" />
			<send string="/2N1{13}"  behavior="tt" var="InletCheckResult" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
			<loadvars string="[InletCheckResult]" type="string" delimiter="," 
							vars="junk,junk,I0,junk,junk,junk,junk,junk,junk,junk"
							multi="True" />
			<if condition="([I0] GT '45000') OR ([I0] LT '35000')">
				<set var="PhosphateBubbleFlag" value="1" />
				<run script="InletAlarm"/>
			</if>
		</if>

		<if condition="[RunNH4] == 1">
			<setdevice name="Ammonium" />
			<send string="/3N1{13}"  behavior="tt" var="InletCheckResult" trigger="{13}" terminator="." keeptrigger="true" keepterminator="false" ms="0" timeout="10000" />
			<loadvars string="[InletCheckResult]" type="string" delimiter="," 
							vars="junk,junk,I0,junk,junk,junk,junk,junk,junk,junk"
							multi="True" />
			<if condition="([I0] GT '45000') OR ([I0] LT '35000')">
				<set var="AmmoniumBubbleFlag" value="1" />
				<run script="InletAlarm"/>
			</if>
		</if>
	</script>

	<script name="EmailAlarm" >
		<typetest var="EmailAlarmNum" type="int" result="isEmailAlarmNum" />
		<if condition="'[isEmailAlarmNum]' == 'False'">
			<set var="EmailAlarmNum" value="1"/>
			<else>
				<math var="EmailAlarmNum" expression="[EmailAlarmNum]+1"/>
			</else>
		</if>
		<if condition="[EmailAlarmNum] LT 4">
			<run script="BuildEmailList" />
			<log message="Email List = [EmailList]" />
			<sizeof var="EmailList" result="SizeOfEmailList" type="length" />
			<if condition="[SizeOfEmailList] GT 7" >
				<email to="[EmailList]" 
				subject="[Station] - [PCdate]" 
				message="The NuLAB system experienced the following error: [Error]" 
				wait="true" onfail="true"/>
			</if>
		</if>
	</script>

	<script name="DailyEmail" >
		<run script="BuildEmailList" />
		<sizeof var="EmailList" result="SizeOfEmailList" type="length" /> 
		<log message="Email List = [EmailList]" />
		<if condition="[SizeOfEmailList] GT 7" >
			<email to="[EmailList]" 
			subject="[Station] daily update" 
			message="Hello from [Station] - attached are the latest data plots" 
			wait="true" onfail="true" 
			files="N+Nobs.png,N+Nconc.png,NO2obs.png,NO2conc.png,NO3conc.png,PO4obs.png,PO4conc.png,NH4obs.png,NH4conc.png" /> 
		</if>   
  	</script>

 	<!--script name="SendData" >
		<loadvars file="FileTransfer.dat" type="text" line="1" delimiter="," vars="HostName,Path,UserName,Password,jnk" multi="False" />
		<log message="File Transfer vars = [HostName],[Path],[UserName],[Password],[jnk],[SFTP] " />		
		<if condition = "[SFTP] != 1" >
			<sendfile localfile="Ammonium_Data-L.txt" remotefile="[Path]Ammonium_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="Nitrate_Data-L.txt" remotefile="[Path]Nitrate_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="Nitrite_Data-L.txt" remotefile="[Path]Nitrite_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="N+N_Data-L.txt" remotefile="[Path]N+N_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="Phosphate_Data-L.txt" remotefile="[Path]Phosphate_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="N+Nobs.png" remotefile="[Path]N+Nobs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="N+Nconc.png" remotefile="[Path]N+Nconc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="NO3conc.png" remotefile="[Path]NO3conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="NO2obs.png" remotefile="[Path]NO2obs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>			
			<sendfile localfile="NO2conc.png" remotefile="[Path]NO2conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="PO4obs.png" remotefile="[Path]PO4obs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="PO4conc.png" remotefile="[Path]PO4conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="NH4obs.png" remotefile="[Path]NH4obs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>
			<sendfile localfile="NH4conc.png" remotefile="[Path]NH4conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="false"/>	
			<else>
				<sendfile localfile="Ammonium_Data-L.txt" remotefile="[Path]Ammonium_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="Nitrate_Data-L.txt" remotefile="[Path]Nitrate_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="Nitrite_Data-L.txt" remotefile="[Path]Nitrite_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="N+N_Data-L.txt" remotefile="[Path]N+N_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="Phosphate_Data-L.txt" remotefile="[Path]Phosphate_Data-L.txt" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="N+Nobs.png" remotefile="[Path]N+Nobs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="N+Nconc.png" remotefile="[Path]N+Nconc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="NO3conc.png" remotefile="[Path]NO3conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="NO2obs.png" remotefile="[Path]NO2obs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>				
				<sendfile localfile="NO2conc.png" remotefile="[Path]NO2conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="PO4obs.png" remotefile="[Path]PO4obs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="PO4conc.png" remotefile="[Path]PO4conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="NH4obs.png" remotefile="[Path]NH4obs.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
				<sendfile localfile="NH4conc.png" remotefile="[Path]NH4conc.png" username="[UserName]" password="[Password]" hostname="[HostName]" onfail="True" sftp="true"/>
			</else>
		</if> 
	</script-->

</scripts>
